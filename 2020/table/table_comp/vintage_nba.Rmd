---
title: "Top-100 Vintage NBA Seasons with {reactable}"
author: "Paul Apivat Hanvongse"
date: "10/25/2020"
output: 
    html_document:
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparing the Data

We'll start off with the raw data from 538. The data accompanies this Rmarkdown file or, alternatively, can be downloaded directly from their [github repository](https://github.com/fivethirtyeight/data/tree/master/nba-raptor). The file we're using is called 'historical_RAPTOR_by_player.csv'. Background information on the RAPTOR metric can be found [here](https://fivethirtyeight.com/features/how-our-raptor-metric-works/). 

We'll load the libraries, then the raw data.

```{r libraries}
library(tidyverse)
library(reactable)
library(htmltools)

# read data
df <- read_csv("historical_RAPTOR_by_player.csv")
df %>% head()
```

## Objective

Here's what the 538 table looks like (**note**: we'll add an extra column not shown in this picture.) This table features 538's most updated NBA statistic, RAPTOR, which stands for Robust Algorithm (using) Player Tracking (and) On/Off Ratings. 

The attempts to rank indiviual (player's) seasons, rather than individual players themselves. 
Our objective is to re-create this table and give it a fresh makeover. 

![538 Raptor Table](./538_raptor.png)

## Data Wrangling

We will wrangle the data to be a close to what we need *before* using the `reactable` package. We'll first select the columns we're interested in. Then we'll filter for players who played for more than 1000 minutes (mp), as done in the original. We'll arrange the data in descending order by WAR - wins above replacement. 

Next, we'll rename the columns to match the names used by 538. Then we'll format all columns with decimal numbers to be rounded to one decimal place. Finally, we'll choose the top 100 rows (after filtering) to keep our data manageable.

We'll save this to a variable called `raptor_table`.

```{r raptor_table, echo=TRUE}

raptor_table <- df %>%
    select(player_name, season, mp, raptor_offense, raptor_defense, raptor_total, war_total, war_playoffs) %>%
    filter(mp > 1000) %>%
    arrange(desc(war_total)) %>%
    rename(
        NAME = player_name,
        SEASON = season,
        MIN_PLAYED = mp,
        OFF = raptor_offense,
        DEF = raptor_defense,
        TOTAL = raptor_total,
        WAR = war_total,
        PLAYOFF_WAR = war_playoffs
    ) %>%
    mutate_at(4:8, funs(round(., 1))) %>% 
    head(100) 
```

## Major Structure and Columns

First, we'll wrap our `raptor_table` within the `reactable()` function. You'll note in the original table that OFF, DEF and TOTAL are *grouped* under RAPTOR. We'll add this structure to the table heading first. 

```{r major}
reactable(
    raptor_table,
    columns = list(
        OFF = colDef(name = "OFF."),
        DEF = colDef(name = "DEF."),
        TOTAL = colDef(name = "TOTAL")
    ),
    columnGroups = list(
        colGroup(name = "RAPTOR", columns = c("OFF", "DEF", "TOTAL"))
    )
)
```

## Major Table Structural Details

Next, we'll add prominent table structural details including its height, mininum rows (10) and making it compact. In addition, we'll enable the sort icon, `showSortIcon`.

We *won't* disable pagination because that will over write our `column grouping` (i.e., RAPTOR).

```{r features}

reactable(
    raptor_table,
    height = 600,
    minRows = 10,
    showSortIcon = TRUE,
    compact = TRUE,
    pagination = TRUE,
    showPageInfo = TRUE,
    columns = list(
        OFF = colDef(name = "OFF."),
        DEF = colDef(name = "DEF."),
        TOTAL = colDef(name = "TOTAL")
    ),
    columnGroups = list(
        colGroup(name = "RAPTOR", columns = c("OFF", "DEF", "TOTAL"))
    )
)
```

## Add Search Box

Next, we'll add a search box as well as placeholder text for readability. You can type in a fake name in the search box and if there are no matches, the text will render "No matches". 

```{r search}

reactable(
    raptor_table,
    height = 600,
    minRows = 10,
    showSortIcon = TRUE,
    compact = TRUE,
    pagination = TRUE,
    showPageInfo = TRUE,
    searchable = TRUE,
    language = reactableLang(searchPlaceholder = "Search...", noData = "No matches"),
    columns = list(
        OFF = colDef(name = "OFF."),
        DEF = colDef(name = "DEF."),
        TOTAL = colDef(name = "TOTAL")
    ),
    columnGroups = list(
        colGroup(name = "RAPTOR", columns = c("OFF", "DEF", "TOTAL"))
    )
)
```

## Format Individual Columns

Now we'll add some formatting and styling to each of the individual columns. This will include **column width** and **font** used within the columns. The bulk of this process will be within the `columns` parameter. In addition to the `OFF`, `DEF` and `TOTAL` columns, we'll add formating for the rest of the columns. 

This includes customizing name, customizing digits (i.e., making sure commas are placed for minutes played), font and font sizes. 

We'll also add a "+" prefix for the `TOTAL` column. Althought we had previously formatted our data to one decimal place, we'll need to explicitly re-state with `format = colFormat(digits = 1)` to make sure all digits line up properly. You'll note that the `style` for `PLAYOFF_WAR` has a `whiteSpace` parameter set to pre - this will be apparent why when we add visuals to this particular column below.

We will style `OFF`, `DEF` and `TOTAL` separately in the next section.

```{r columns}

reactable(
    raptor_table,
    height = 600,
    minRows = 10,
    showSortIcon = TRUE,
    compact = TRUE,
    pagination = TRUE,
    showPageInfo = TRUE,
    searchable = TRUE,
    language = reactableLang(searchPlaceholder = "Search...", noData = "No matches"),
    columns = list(
        NAME = colDef(minWidth = 120, style = list(fontFamily = "liberation mono", fontSize = 14)),
        SEASON = colDef(minWidth = 60, style = list(fontFamily = "liberation mono", fontSize = 14), align = "left"),
        MIN_PLAYED = colDef(name = 'MIN. PLAYED', format = colFormat(separators = TRUE), minWidth = 60, style = list(fontFamily = "liberation mono", fontSize = 14), align = 'right'),
        OFF = colDef(name = "OFF.", format = colFormat(digits = 1), minWidth = 60, align = 'right'),
        DEF = colDef(name = "DEF.", format = colFormat(digits = 1), minWidth = 60, align = 'right'),
        TOTAL = colDef(name = "TOTAL", format = colFormat(prefix = "+", digits = 1), minWidth = 60, align = 'right'),
        WAR = colDef(format = colFormat(digits = 1), minWidth = 60, style = list(fontFamily = "liberation mono", fontSize = 14), align = "right"),
        PLAYOFF_WAR = colDef(name = "P/O WAR", format = colFormat(digits = 1), minWidth = 100, align = 'center', style = list(fontFamily = "liberation mono", whiteSpace = "pre", fontSize = 14))
    ),
    columnGroups = list(
        colGroup(name = "RAPTOR", columns = c("OFF", "DEF", "TOTAL"))
    )
)
```